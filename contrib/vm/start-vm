#!/bin/bash
set -o errexit
set -o nounset
#set -o xtrace

VM=$1
SSHPORT=$2

if [[ `virsh domstate $VM` != "running" ]]; then
    if ! virsh start $VM; then
       echo "Failed to start $VM!"
       exit 1
    fi
    echo "Booting $VM"
    sleep 5
fi

./vm/forward-port $VM $SSHPORT 22
while [[ `ssh -oNoHostAuthenticationForLocalhost=yes root@localhost -p $SSHPORT echo "ready"` != "ready" ]]; do
    echo "Waiting for $VM to start."
    sleep 5
done
