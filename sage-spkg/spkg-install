#!/usr/bin/env bash

# spkg-install for SageCell, generated by SageCell's spkg-dist

if [[ -z "$SAGE_LOCAL" ]]; then
   echo "SAGE_LOCAL undefined ... exiting"
   echo "Maybe run 'sage --sh'?"
   exit 1
fi

export C_INCLUDE_PATH="$SAGE_ROOT"/local/include

cd src

SRC="`pwd`"

cd $SAGE_ROOT/devel/sage/
if hg qseries | grep -q 01-sage-embedded.patch;  then
    echo "Sage patches already applied.  Checking the patches..."
    cmp -s .hg/patches/01-sage-embedded.patch $SRC/sagecell/sage-patches/01-sage-embedded.patch
    if [ $? -ne 0 ]; then
        echo >&2 "Error: you have an out-of-date 01-sage-embedded.patch; remove this and reinstall the spkg."
        exit 1
    fi
    cmp -s .hg/patches/02-sage-show.patch $SRC/sagecell/sage-patches/02-sage-show.patch
    if [ $? -ne 0 ]; then
        echo >&2 "Error: you have an out-of-date 02-sage-show.patch applied to Sage; remove this and reinstall the spkg."
        exit 1
    fi
    cmp -s .hg/patches/sagecell2.patch $SRC/sagecell/sage-patches/sagecell2.patch
    if [ $? -ne 0 ]; then
        echo >&2 "Error: you have an out-of-date sagecell2.patch applied to Sage; remove this and reinstall the spkg."
        exit 1
    fi
    echo "Patches are the same as what we would apply."
else
echo "Patching Sage"
hg qimport $SRC/sagecell/sage-patches/01-sage-embedded.patch
if [ $? -ne 0 ]; then
    echo >&2 "Error importing patch 01-sage-embedded.patch."
    exit 1
fi
hg qpush
if [ $? -ne 0 ]; then
    echo >&2 "Error pushing patch 01-sage-embedded.patch."
    exit 1
fi
hg qimport $SRC/sagecell/sage-patches/02-sage-show.patch
if [ $? -ne 0 ]; then
    echo >&2 "Error importing patch 02-sage-show.patch."
    exit 1
fi
hg qpush
if [ $? -ne 0 ]; then
    echo >&2 "Error pushing patch 02-sage-show.patch."
    exit 1
fi

hg qimport $SRC/sagecell/sage-patches/sagecell2.patch
if [ $? -ne 0 ]; then
    echo >&2 "Error importing patch sagecell2.patch."
    exit 1
fi
hg qpush
if [ $? -ne 0 ]; then
    echo >&2 "Error pushing patch sagecell2.patch."
    exit 1
fi
fi

$SAGE_ROOT/sage -b

cd $SRC

echo "Installing zeromq"
cd zeromq
./configure --prefix="$SAGE_LOCAL"
if [ $? -ne 0 ]; then
    echo >&2 "Error configuring zeromq."
    exit 1
fi

$MAKE
if [ $? -ne 0 ]; then
   echo "Error building zeromq."
   exit 1
fi

$MAKE install
if [ $? -ne 0 ]; then
   echo "Error installing zeromq."
   exit 1
fi

echo "Installing python dependencies"
cd $SRC
%(install_python_dependencies)s

cd $SRC

if [ -d "$SAGE_ROOT/devel/sagecell-main" ]; then
    echo "Moving old SageCell package to '$SAGE_ROOT/devel/sagecell-main-old'..."
    rm -rf "$SAGE_ROOT/devel/sagecell-main-old"
    mv "$SAGE_ROOT/devel/sagecell-main" "$SAGE_ROOT/devel/sagecell-main-old"
    if [ $? -ne 0 ]; then
        echo >&2 "Error moving the old 'sagecell-main'."
        exit 1
    fi
fi

rm -f "$SAGE_ROOT/devel/sagecell" # Delete just the link itself (if it exists)

# We need to have -R below so symbolic links are copied correctly
echo "Copying sagecell source"

cp -pR sagecell "$SAGE_ROOT/devel/sagecell-main" # Creates new sagecell-main dir
if [ $? -ne 0 ]; then
    echo >&2 "Error copying the new SageCell package."
    exit 1
fi

echo "Creating devel/sagecell symbolic link"
cd "$SAGE_ROOT/devel"
ln -s sagecell-main sagecell # Create new symbolic link (deleted above)
if [ $? -ne 0 ]; then
    echo >&2 "Error creating symbolic link to '$SAGE_ROOT/devel/sagecell-main'."
    exit 1
fi

SAGECELL="$SAGE_ROOT/devel/sagecell"

echo "Creating jmol link"
cd "$SAGECELL/static"
ln -s "$SAGE_ROOT/local/share/jmol" .
if [ $? -ne 0 ]; then
    echo >&2 "Error making jmol symbolic link."
    exit 1
fi

echo "Running make in sagecell"
cd "$SAGECELL"
make
if [ $? -ne 0 ]; then
    echo >&2 "Error minifying javascript and CSS."
    exit 1
fi

